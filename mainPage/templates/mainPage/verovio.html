{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>ScoreWriter</title>
    <link rel="icon" href="static/images/favicon-16x16.png">
    <script src="https://www.verovio.org/javascript/develop/verovio-toolkit.js" type="text/javascript"></script>
    <!-- We also use jQuery -->
    <script src="{% static 'javascript/jquery-3.5.1.min.js' %}" type="text/javascript"></script>
    <!-- Basic events from example 02 -->
    <script src="{% static 'javascript/basic-events.js' %}" type="text/javascript"></script>
    <!-- A stylesheet for the help overlay -->
    <link rel="stylesheet" href="{% static 'css/tutorial.css' %}" />
    <!--/////////////-->
    <!-- MIDI Player -->
    <!--/////////////-->
    <script type="text/javascript" language="javascript"
        src="{% static 'javascript/midi-player/wildwebmidi.js' %}"></script>
    <script type="text/javascript" language="javascript"
        src="{% static 'javascript/midi-player/midiplayer.js' %}"></script>
    <link rel="stylesheet" href="{% static 'css/midiplayer.css' %}" />
    <!--Bootstrap-->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>

</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light" style="background-color: #273c75;">
        <a class="navbrand" href="{% url 'mainPage:index' %}"
            style="color: white; font-size: xx-large; font-weight: bold; text-decoration: none;">Score Writer</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
                <!--
            <li class="nav-item active">
              <a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
            </li>
            -->

            </ul>

            <form class="form-horizontal">
                <div class="form-group">
                    <div class="col-sm-offset-2 col-sm-10">
                        <label class="file-upload btn btn-secondary">
                            <input type="file" />
                        </label>
                    </div>
                </div>
            </form>
        </div>
    </nav>
    <!-- A help overlay -->
    <div id="help_overlay">
        <p>Press <b>p</b> to start playing</p>
        <p>Click on any note or in the player progress bar to jump in the piece</p>
    </div>

    <!--//////////////////////////////////////////////////////-->
    <!-- The div where we are going to insert the MIDI Player -->
    <!--//////////////////////////////////////////////////////-->
    <div style="height: 30px;">
        <div id="player" style="z-index: 20; position: absolute; display: none;"></div>
    </div>

    <!-- The div where we are going to insert the SVG -->
    <div id="svg_output" />

    <script type="text/javascript">
        var vrvToolkit = new verovio.toolkit();
        var page = 1;
        var zoom = 60;
        var pageHeight = 2970;
        var pageWidth = 2100;

        ////////////////////////////////////////////////
        /* A variable for storing the highlighted ids */
        ////////////////////////////////////////////////
        var ids = [];
        var isPlaying = false;

        function setOptions() {
            pageHeight = $(document).height() * 100 / zoom;
            pageWidth = $(document).width() * 100 / zoom;
            options = {
                pageHeight: pageHeight,
                pageWidth: pageWidth,
                scale: zoom,
                adjustPageHeight: true
            };
            vrvToolkit.setOptions(options);
        }

        function loadData(data) {
            setOptions();
            vrvToolkit.loadData(data);

            page = 1;
            loadPage();
        }

        function loadPage() {
            svg = vrvToolkit.renderToSVG(page, {});
            $("#svg_output").html(svg);

            ////////////////////////////////////////
            /* Bind a on click event to each note */
            ////////////////////////////////////////
            $(".note").click(function () {
                var id = $(this).attr("id");
                var time = vrvToolkit.getTimeForElement(id);
                $("#midi-player").midiPlayer.seek(time);
            });
        };

        function loadFile() {
            // mei파일 로드하는곳...
            file = "static/mei/complete_music.mei";
            $.ajax({
                url: file
                , dataType: "text"
                , success: function (data) {
                    loadData(data);
                }
            });
        }

        ////////////////////////////////////////////
        /* A function that start playing the file */
        ////////////////////////////////////////////
        function play_midi() {
            if (isPlaying == false) {
                var base64midi = vrvToolkit.renderToMIDI();
                var song = 'data:audio/midi;base64,' + base64midi;
                $("#player").show();
                $("#player").midiPlayer.play(song);
                isPlaying = true;
            }
        }

        //////////////////////////////////////////////////////
        /* Two callback functions passed to the MIDI player */
        //////////////////////////////////////////////////////
        var midiUpdate = function (time) {
            // time needs to - 400 for adjustment
            var vrvTime = Math.max(0, time - 400);
            var elementsattime = vrvToolkit.getElementsAtTime(vrvTime);
            if (elementsattime.page > 0) {
                if (elementsattime.page != page) {
                    page = elementsattime.page;
                    loadPage();
                }
                if ((elementsattime.notes.length > 0) && (ids != elementsattime.notes)) {
                    ids.forEach(function (noteid) {
                        if ($.inArray(noteid, elementsattime.notes) == -1) {
                            $("#" + noteid).attr("fill", "#000").attr("stroke", "#000");
                        }
                    });
                    ids = elementsattime.notes;
                    ids.forEach(function (noteid) {
                        if ($.inArray(noteid, elementsattime.notes) != -1) {
                            $("#" + noteid).attr("fill", "#c00").attr("stroke", "#c00");;
                        }
                    });
                }
            }
        }

        var midiStop = function () {
            ids.forEach(function (noteid) {
                $("#" + noteid).attr("fill", "#000").attr("stroke", "#000");
            });
            $("#player").hide();
            isPlaying = false;
        }

        $(document).ready(function () {

            $(window).keyup(function (event) {
                ////////////////////////////////
                /* Key events 'p' for playing */
                ////////////////////////////////
                if (event.keyCode == 80) {
                    play_midi();
                }
            });

            $(window).resize(function () {
                applyZoom();
            });

            $("#player").midiPlayer({
                color: "#c00",
                onUpdate: midiUpdate,
                onStop: midiStop,
                width: 250
            });

            loadFile();
        });
    </script>
</body>

</html>